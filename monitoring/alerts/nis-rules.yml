# NIS TOOLKIT SUIT v4.0.0 - Prometheus Alert Rules
# Comprehensive alerting rules for system monitoring

groups:
  # System Health Alerts
  - name: nis.system.health
    interval: 30s
    rules:
      - alert: NISSystemDown
        expr: nis_system_up{component="main"} == 0
        for: 30s
        labels:
          severity: critical
          category: system
          service: nis-toolkit
        annotations:
          summary: "NIS TOOLKIT SUIT system is down"
          description: "The main NIS system has been down for more than 30 seconds on instance {{ $labels.instance }}"
          runbook_url: "https://docs.nis.local/runbooks/system-down"
          dashboard_url: "http://grafana.nis.local/d/nis-system-overview"
      
      - alert: NISSystemHighCPU
        expr: nis_cpu_usage_percent{component="system"} > 80
        for: 5m
        labels:
          severity: high
          category: performance
          service: nis-toolkit
        annotations:
          summary: "High CPU usage detected"
          description: "CPU usage is above 80% (current value: {{ $value }}%) for more than 5 minutes on {{ $labels.instance }}"
          
      - alert: NISSystemHighMemory
        expr: nis_memory_usage_bytes{component="system", type="used"} / nis_memory_usage_bytes{component="system", type="total"} * 100 > 85
        for: 5m
        labels:
          severity: high
          category: performance
          service: nis-toolkit
        annotations:
          summary: "High memory usage detected"
          description: "Memory usage is above 85% for more than 5 minutes on {{ $labels.instance }}"
          
      - alert: NISSystemLowDiskSpace
        expr: (nis_disk_usage_bytes{type="used"} / (nis_disk_usage_bytes{type="used"} + nis_disk_usage_bytes{type="free"}) * 100) > 90
        for: 1m
        labels:
          severity: critical
          category: system
          service: nis-toolkit
        annotations:
          summary: "Low disk space warning"
          description: "Disk space usage is above 90% on {{ $labels.mount_point }} ({{ $labels.instance }})"

  # Agent Performance Alerts
  - name: nis.agents.performance
    interval: 30s
    rules:
      - alert: NISAgentHighErrorRate
        expr: rate(nis_agent_errors_total[5m]) > 0.1
        for: 2m
        labels:
          severity: high
          category: agent
          service: nis-agent
        annotations:
          summary: "High error rate for NIS agent"
          description: "Agent {{ $labels.agent_type }}/{{ $labels.agent_id }} has error rate > 0.1 errors/sec for 2 minutes"
          
      - alert: NISAgentSlowResponse
        expr: histogram_quantile(0.95, rate(nis_agent_request_duration_seconds_bucket[5m])) > 5
        for: 3m
        labels:
          severity: medium
          category: performance
          service: nis-agent
        annotations:
          summary: "Slow agent response times"
          description: "95th percentile response time for {{ $labels.agent_type }} is above 5 seconds (current: {{ $value }}s)"
          
      - alert: NISAgentHighMemoryUsage  
        expr: nis_agent_memory_usage_bytes / (1024 * 1024 * 1024) > 2
        for: 5m
        labels:
          severity: medium
          category: performance
          service: nis-agent
        annotations:
          summary: "High memory usage by agent"
          description: "Agent {{ $labels.agent_type }}/{{ $labels.agent_id }} is using more than 2GB memory (current: {{ $value | humanize }}B)"
          
      - alert: NISAgentQueueBacklog
        expr: nis_agent_queue_length > 100
        for: 2m
        labels:
          severity: high
          category: performance
          service: nis-agent
        annotations:
          summary: "Agent processing queue backlog"
          description: "Agent {{ $labels.agent_type }}/{{ $labels.agent_id }} has {{ $value }} items in processing queue"
          
      - alert: NISAgentLowConfidence
        expr: nis_agent_confidence_score < 0.7
        for: 5m
        labels:
          severity: medium
          category: quality
          service: nis-agent
        annotations:
          summary: "Low agent confidence scores"
          description: "Agent {{ $labels.agent_type }}/{{ $labels.agent_id }} confidence score is below 70% (current: {{ $value | humanizePercentage }})"

  # Request Rate and Throughput Alerts
  - name: nis.requests.throughput
    interval: 30s
    rules:
      - alert: NISLowRequestRate
        expr: rate(nis_agent_requests_total[10m]) < 0.1
        for: 5m
        labels:
          severity: medium
          category: performance  
          service: nis-toolkit
        annotations:
          summary: "Low request rate detected"
          description: "Request rate for {{ $labels.agent_type }} is below 0.1 req/sec for 5 minutes"
          
      - alert: NISHighRequestRate
        expr: rate(nis_agent_requests_total[5m]) > 100
        for: 2m
        labels:
          severity: high
          category: performance
          service: nis-toolkit
        annotations:
          summary: "Unusually high request rate"
          description: "Request rate for {{ $labels.agent_type }} is above 100 req/sec (current: {{ $value }} req/sec)"
          
      - alert: NISRequestFailureRate
        expr: rate(nis_agent_requests_total{status=~"4..|5.."}[5m]) / rate(nis_agent_requests_total[5m]) > 0.05
        for: 3m
        labels:
          severity: high
          category: reliability
          service: nis-toolkit
        annotations:
          summary: "High request failure rate"
          description: "Request failure rate is above 5% for {{ $labels.agent_type }} (current: {{ $value | humanizePercentage }})"

  # Cache Performance Alerts  
  - name: nis.cache.performance
    interval: 30s
    rules:
      - alert: NISCacheLowHitRate
        expr: rate(nis_cache_hits_total[10m]) / (rate(nis_cache_hits_total[10m]) + rate(nis_cache_misses_total[10m])) < 0.8
        for: 5m
        labels:
          severity: medium
          category: performance
          service: nis-cache
        annotations:
          summary: "Low cache hit rate"
          description: "Cache hit rate for {{ $labels.cache_type }} is below 80% (current: {{ $value | humanizePercentage }})"
          
      - alert: NISCacheHighSize
        expr: nis_cache_size_bytes / (1024 * 1024 * 1024) > 5
        for: 2m
        labels:
          severity: medium
          category: performance
          service: nis-cache
        annotations:
          summary: "Cache size is growing large"
          description: "Cache {{ $labels.cache_type }} size is above 5GB (current: {{ $value | humanize }}B)"

  # Database Performance Alerts (if applicable)
  - name: nis.database.performance
    interval: 30s
    rules:
      - alert: NISDBHighConnections
        expr: nis_database_connections_active > 80
        for: 3m
        labels:
          severity: high
          category: performance
          service: nis-database
        annotations:
          summary: "High database connection count"
          description: "Database {{ $labels.database }} has {{ $value }} active connections"
          
      - alert: NISDBSlowQueries
        expr: histogram_quantile(0.95, rate(nis_database_query_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: medium
          category: performance  
          service: nis-database
        annotations:
          summary: "Slow database queries detected"
          description: "95th percentile query time for {{ $labels.database }} is above 1 second (current: {{ $value }}s)"

  # Security and Compliance Alerts
  - name: nis.security
    interval: 15s
    rules:
      - alert: NISUnauthorizedAccess
        expr: increase(nis_agent_errors_total{error_type="authentication_failed"}[5m]) > 5
        for: 30s
        labels:
          severity: critical
          category: security
          service: nis-toolkit
        annotations:
          summary: "Multiple authentication failures detected"
          description: "{{ $value }} authentication failures in the last 5 minutes for {{ $labels.agent_type }}"
          
      - alert: NISAnomalousTraffic
        expr: rate(nis_agent_requests_total[1m]) > rate(nis_agent_requests_total[1h]) * 5
        for: 1m
        labels:
          severity: high
          category: security
          service: nis-toolkit
        annotations:
          summary: "Anomalous traffic pattern detected"
          description: "Current request rate is 5x higher than the hourly average for {{ $labels.agent_type }}"

  # Business Logic Alerts
  - name: nis.business
    interval: 60s
    rules:
      - alert: NISLowTaskCompletionRate
        expr: nis_task_completion_rate < 0.95
        for: 10m
        labels:
          severity: medium
          category: quality
          service: nis-toolkit
        annotations:
          summary: "Low task completion rate"
          description: "Task completion rate for {{ $labels.task_type }} is below 95% (current: {{ $value | humanizePercentage }})"
          
      - alert: NISNoActiveUsers
        expr: nis_user_sessions_active == 0
        for: 10m
        labels:
          severity: low
          category: business
          service: nis-toolkit
        annotations:
          summary: "No active user sessions"
          description: "No active user sessions detected for 10 minutes"

  # Model Performance Alerts
  - name: nis.model.performance  
    interval: 30s
    rules:
      - alert: NISModelSlowInference
        expr: histogram_quantile(0.95, rate(nis_model_inference_duration_seconds_bucket[5m])) > 2
        for: 5m
        labels:
          severity: medium
          category: performance
          service: nis-model
        annotations:
          summary: "Slow model inference times"
          description: "95th percentile inference time for {{ $labels.model_name }} is above 2 seconds (current: {{ $value }}s)"
          
      - alert: NISModelInferenceErrors
        expr: increase(nis_agent_errors_total{error_type=~"model.*"}[5m]) > 10
        for: 2m
        labels:
          severity: high
          category: reliability
          service: nis-model
        annotations:
          summary: "High model inference error rate"
          description: "{{ $value }} model errors in the last 5 minutes for {{ $labels.model_name }}"

  # Deadman Switch - ensures monitoring is working
  - name: nis.monitoring.health
    interval: 30s
    rules:
      - alert: NISMonitoringDeadmanSwitch
        expr: vector(1)
        labels:
          severity: low
          category: monitoring
          service: nis-monitoring
        annotations:
          summary: "NIS monitoring is alive"
          description: "This alert ensures that the monitoring system is functioning properly"
